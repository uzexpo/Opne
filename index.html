<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open Interpreter - AI Agent</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .app-header {
      background: rgba(0, 0, 0, 0.3);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .header-title {
      font-size: 24px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-connected {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .status-disconnected {
      background: rgba(244, 67, 54, 0.2);
      color: #F44336;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }
    
    .status-connecting {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .control-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .control-btn:active {
      transform: translateY(0);
    }
    
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 80px);
      padding: 20px;
      gap: 20px;
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .chat-controls {
      display: flex;
      gap: 10px;
    }
    
    .messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: rgba(255, 255, 255, 0.8);
    }
    
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in;
      position: relative;
    }
    
    .message.user {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      align-self: flex-end;
      margin-left: auto;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .message.assistant {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      align-self: flex-start;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .message.system {
      background: rgba(255, 193, 7, 0.9);
      color: #333;
      align-self: center;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
    }
    
    .message.error {
      background: rgba(244, 67, 54, 0.9);
      color: white;
      align-self: center;
      text-align: center;
      font-weight: bold;
    }
    
    .message.success {
      background: rgba(76, 175, 80, 0.9);
      color: white;
      align-self: center;
      text-align: center;
      font-weight: bold;
    }
    
    .input-container {
      padding: 20px;
      background: rgba(255, 255, 255, 0.9);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    #messageInput {
      flex: 1;
      padding: 15px 20px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    #messageInput:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .action-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .action-btn:active {
      transform: translateY(0);
    }
    
    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .secondary-btn {
      background: rgba(255, 255, 255, 0.2);
      color: #333;
      border: 1px solid rgba(0, 0, 0, 0.1);
      padding: 12px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .secondary-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      align-self: flex-start;
      font-style: italic;
      color: #666;
    }
    
    .dots {
      display: inline-block;
      animation: dots 1.5s infinite;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    .quick-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .quick-action {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 8px 15px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    .quick-action:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .server-log {
      background: rgba(0, 0, 0, 0.8);
      color: #00ff00;
      padding: 10px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 100px;
      overflow-y: auto;
      margin-top: 10px;
      display: none;
    }
    
    .server-log.show {
      display: block;
    }
    
    /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.7);
    }
  </style>
</head>
<body>
  <div class="app-header">
    <div class="header-title">
      ü§ñ Open Interpreter - AI Agent
    </div>
    <div class="header-controls">
      <div id="statusIndicator" class="status-indicator status-disconnected">
        <span id="statusDot">üî¥</span>
        <span id="statusText">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
      </div>
      <button id="serverBtn" class="control-btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
      <button id="clearBtn" class="control-btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button id="logBtn" class="control-btn">–õ–æ–≥ —Å–µ—Ä–≤–µ—Ä–∞</button>
    </div>
  </div>
  
  <div class="main-container">
    <div class="quick-actions">
      <div class="quick-action" onclick="sendQuickCommand('–ü—Ä–∏–≤–µ—Ç! –ü–æ–∫–∞–∂–∏ –≤—Ä–µ–º—è')">üïê –í—Ä–µ–º—è</div>
      <div class="quick-action" onclick="sendQuickCommand('–û—Ç–∫—Ä–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä')">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
      <div class="quick-action" onclick="sendQuickCommand('–í–∫–ª—é—á–∏ –º—É–∑—ã–∫—É')">üéµ –ú—É–∑—ã–∫–∞</div>
      <div class="quick-action" onclick="sendQuickCommand('–°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç')">üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç</div>
      <div class="quick-action" onclick="sendQuickCommand('–ü–æ–∫–∞–∂–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ')">üíª –°–∏—Å—Ç–µ–º–∞</div>
      <div class="quick-action" onclick="sendQuickCommand('–ù–∞–π–¥–∏ —Ñ–∞–π–ª test.txt')">üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤</div>
    </div>
    
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-title">üí¨ –ß–∞—Ç —Å AI –∞–≥–µ–Ω—Ç–æ–º</div>
        <div class="chat-controls">
          <button id="saveBtn" class="secondary-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="loadBtn" class="secondary-btn">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </div>
      
      <div id="messages" class="messages">
        <div class="message system">
          ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Open Interpreter!<br>
          –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å –≤–∞–º —Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π –∫–æ–º–ø—å—é—Ç–µ—Ä–∞.
        </div>
      </div>
      
      <div class="input-container">
        <div class="input-row">
          <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è AI –∞–≥–µ–Ω—Ç–∞..." />
          <button id="sendBtn" class="action-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <div id="serverLog" class="server-log"></div>
      </div>
    </div>
  </div>
  
  <script>
    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Electron API
    const { ipcRenderer } = require('electron');
    
    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    let messagesContainer = document.getElementById('messages');
    let messageInput = document.getElementById('messageInput');
    let sendBtn = document.getElementById('sendBtn');
    let clearBtn = document.getElementById('clearBtn');
    let serverBtn = document.getElementById('serverBtn');
    let logBtn = document.getElementById('logBtn');
    let saveBtn = document.getElementById('saveBtn');
    let loadBtn = document.getElementById('loadBtn');
    let statusIndicator = document.getElementById('statusIndicator');
    let statusDot = document.getElementById('statusDot');
    let statusText = document.getElementById('statusText');
    let serverLog = document.getElementById('serverLog');
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let socket = null;
    let isConnecting = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let serverRunning = false;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Electron –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      setupEventListeners();
      checkServerStatus();
    });
    
    function setupEventListeners() {
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
      clearBtn.addEventListener('click', clearMessages);
      
      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–º
      serverBtn.addEventListener('click', toggleServer);
      logBtn.addEventListener('click', toggleServerLog);
      
      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞
      saveBtn.addEventListener('click', saveChat);
      loadBtn.addEventListener('click', loadChat);
      
      // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'l') {
          e.preventDefault();
          clearMessages();
        }
        if (e.key === 'Escape') {
          messageInput.value = '';
          messageInput.focus();
        }
      });
    }
    
    async function checkServerStatus() {
      try {
        const status = await ipcRenderer.invoke('get-server-status');
        serverRunning = status.isRunning;
        updateServerButton();
        if (serverRunning) {
          connectToServer();
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞:', error);
      }
    }
    
    async function toggleServer() {
      if (serverRunning) {
        const result = await ipcRenderer.invoke('stop-server');
        if (result.success) {
          serverRunning = false;
          updateServerButton();
          updateStatus('disconnected', '–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
          if (socket) {
            socket.close();
            socket = null;
          }
          addMessage('system', 'üîö –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        }
      } else {
        const result = await ipcRenderer.invoke('start-server');
        if (result.success) {
          serverRunning = true;
          updateServerButton();
          connectToServer();
          addMessage('system', 'üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω');
        } else {
          addMessage('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${result.message}`);
        }
      }
    }
    
    function updateServerButton() {
      if (serverRunning) {
        serverBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä';
        serverBtn.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
      } else {
        serverBtn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä';
        serverBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #388E3C 100%)';
      }
    }
    
    function toggleServerLog() {
      serverLog.classList.toggle('show');
      logBtn.textContent = serverLog.classList.contains('show') ? '–°–∫—Ä—ã—Ç—å –ª–æ–≥' : '–õ–æ–≥ —Å–µ—Ä–≤–µ—Ä–∞';
    }
    
    function connectToServer() {
      if (isConnecting || socket?.readyState === WebSocket.OPEN) {
        return;
      }
      
      isConnecting = true;
      updateStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
      console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');
      
      try {
        socket = new WebSocket('ws://localhost:8765');
        
        socket.onopen = () => {
          console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
          isConnecting = false;
          reconnectAttempts = 0;
          updateStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
          enableInput();
          addMessage('system', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        };
        
        socket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleServerMessage(data);
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
          }
        };
        
        socket.onclose = (event) => {
          console.log('üîö –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ:', event.code);
          isConnecting = false;
          updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ');
          disableInput();
          addMessage('system', `üîö –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ (–∫–æ–¥: ${event.code})`);
        };
        
        socket.onerror = (error) => {
          console.error('‚ùå –û—à–∏–±–∫–∞ WebSocket:', error);
          isConnecting = false;
          updateStatus('disconnected', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
          addMessage('error', '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
        };
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket:', error);
        isConnecting = false;
        updateStatus('disconnected', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        addMessage('error', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
      }
    }
    
    function handleServerMessage(data) {
      const { type, message, content } = data;
      
      switch (type) {
        case 'system':
          hideTyping();
          addMessage('system', message);
          break;
        case 'user_echo':
          // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ
          break;
        case 'processing':
          addMessage('system', message);
          showTyping();
          break;
        case 'response':
          hideTyping();
          addMessage('assistant', message);
          break;
        case 'error':
          hideTyping();
          addMessage('error', message);
          break;
        case 'success':
          hideTyping();
          addMessage('success', message);
          break;
        default:
          console.warn('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:', type, data);
      }
    }
    
    function sendMessage() {
      const message = messageInput.value.trim();
      
      if (!message) return;
      
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        addMessage('error', '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
        return;
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      addMessage('user', message);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
      showTyping();
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      try {
        socket.send(JSON.stringify({ message }));
        messageInput.value = '';
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        addMessage('error', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
      }
    }
    
    function sendQuickCommand(command) {
      messageInput.value = command;
      sendMessage();
    }
    
    function addMessage(type, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
      const formattedContent = formatMessage(content);
      messageDiv.innerHTML = formattedContent;
      
      messagesContainer.appendChild(messageDiv);
      scrollToBottom();
    }
    
    function formatMessage(content) {
      if (!content) return '';
      
      // –ë–∞–∑–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
      let formatted = content
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code>$1</code>');
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
      formatted = formatted.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
        return `<pre><code class="language-${lang || 'text'}">${code.trim()}</code></pre>`;
      });
      
      return formatted;
    }
    
    function showTyping() {
      if (!document.getElementById('typing-indicator')) {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = 'ü§ñ AI –∞–≥–µ–Ω—Ç –ø–µ—á–∞—Ç–∞–µ—Ç<span class="dots">...</span>';
        messagesContainer.appendChild(typingDiv);
        scrollToBottom();
      }
    }
    
    function hideTyping() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }
    
    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function updateStatus(status, text) {
      statusText.textContent = text;
      statusIndicator.className = `status-indicator status-${status}`;
      
      switch (status) {
        case 'connected':
          statusDot.textContent = 'üü¢';
          break;
        case 'connecting':
          statusDot.textContent = 'üü°';
          break;
        case 'disconnected':
          statusDot.textContent = 'üî¥';
          break;
      }
    }
    
    function enableInput() {
      messageInput.disabled = false;
      sendBtn.disabled = false;
      messageInput.focus();
    }
    
    function disableInput() {
      messageInput.disabled = true;
      sendBtn.disabled = true;
    }
    
    function clearMessages() {
      messagesContainer.innerHTML = '';
      addMessage('system', 'üßπ –ß–∞—Ç –æ—á–∏—â–µ–Ω');
      messageInput.focus();
    }
    
    async function saveChat() {
      try {
        const messages = Array.from(messagesContainer.children).map(msg => ({
          type: msg.className.replace('message ', ''),
          content: msg.textContent
        }));
        
        const filePath = await ipcRenderer.invoke('save-file', 'chat_history.json');
        if (filePath) {
          const fs = require('fs');
          fs.writeFileSync(filePath, JSON.stringify(messages, null, 2));
          addMessage('success', `üíæ –ß–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ ${filePath}`);
        }
      } catch (error) {
        addMessage('error', `‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`);
      }
    }
    
    async function loadChat() {
      try {
        const filePath = await ipcRenderer.invoke('select-file');
        if (filePath) {
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
          
          clearMessages();
          data.forEach(msg => {
            addMessage(msg.type, msg.content);
          });
          
          addMessage('success', `üìÅ –ß–∞—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ ${filePath}`);
        }
      } catch (error) {
        addMessage('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ –æ—Ç main –ø—Ä–æ—Ü–µ—Å—Å–∞
    ipcRenderer.on('server-status', (event, data) => {
      if (data.type === 'output') {
        console.log('üì° –°–µ—Ä–≤–µ—Ä:', data.message);
        if (serverLog.classList.contains('show')) {
          serverLog.innerHTML += `<div>${data.message}</div>`;
          serverLog.scrollTop = serverLog.scrollHeight;
        }
      } else if (data.type === 'error') {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data.message);
        addMessage('error', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.message}`);
      }
    });
    
    console.log('‚úÖ Electron –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
  </script>
</body>
</html>
